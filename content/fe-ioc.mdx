---
title: 'èŠèŠå‰ç«¯ç ”å‘ä¸­çš„æ§åˆ¶åè½¬å’Œä¾èµ–æ³¨å…¥'
publishedAt: '2022-05-23'
summary: "æœ¬æ–‡å¸Œæœ›é€šè¿‡å‰ç«¯è§†è§’ï¼Œä»¥ Typescript ä½œä¸ºç¼–ç¨‹è¯­è¨€ï¼Œè°ˆè°ˆå¦‚ä½•ä½¿ç”¨ IoC å’Œ DI ç­‰æœºåˆ¶ï¼Œè®©å¤§å‹çš„å‰ç«¯é¡¹ç›®åœ¨è§£å†³ä»£ç ä¾èµ–ã€å¤ç”¨å’Œæ‰©å±•çš„æ—¶å€™ï¼Œè½»æ¾è‡ªå¦‚ï¼Œæ¸¸åˆƒæœ‰ä½™ã€‚"
tags: ['Frontend', 'cn']
---

## èƒŒæ™¯

ä»¥ Web æŠ€æœ¯ä¸ºä¸­å¿ƒçš„å‰ç«¯æŠ€æœ¯ï¼Œåœ¨è¿‘å‡ å¹´å‘å±•å°¤ä¸ºè¿…çŒ›ï¼Œè¯ç”Ÿäº†è¯¸å¤šå¦‚ Typescriptã€Angular ç­‰å‰ç«¯æŠ€æœ¯ï¼Œæ”¯æ’‘äº† VSCode è¿™ç±»å²è¯—çº§é¡¹ç›®çš„è¯ç”Ÿã€‚åœ¨è¿™äº›å¤§å‹å·¥ç¨‹ / é¡¹ç›®ä¸­ï¼Œæ¶æ„å¸ˆä»¬ä¸ºäº†è®©é¡¹ç›®åœ¨å¦‚æ­¤å¤§è§„æ¨¡çš„ååŒä¸‹ï¼Œä¾æ—§èƒ½å¤Ÿæœ‰æ•ˆæ§åˆ¶å¤æ‚åº¦ã€‚ä»–ä»¬åœ¨è¿™äº›å·¥ç¨‹ä¸­æ·±åº¦å®è·µäº†é¢å‘å¯¹è±¡ï¼ˆOOï¼‰çš„ç¼–ç¨‹èŒƒå¼ï¼Œå…¶ä¸­ **æ§åˆ¶åè½¬**ï¼ˆ_Inversion of Control_ï¼Œåæ–‡ç®€ç§° IoCï¼‰ä»¥åŠ **ä¾èµ–æ³¨å…¥**ï¼ˆ_Dependency Injection_ï¼Œåæ–‡ç®€ç§° DIï¼‰ï¼Œè¿™ä¸¤ç§æŠ€æœ¯æ‰‹æ®µè¢«å¤§é‡ä½¿ç”¨ã€‚

æœ¬æ–‡å¸Œæœ›é€šè¿‡å‰ç«¯è§†è§’ï¼Œä»¥ Typescript ä½œä¸ºç¼–ç¨‹è¯­è¨€ï¼Œè°ˆè°ˆå¦‚ä½•ä½¿ç”¨ IoC å’Œ DI ç­‰æœºåˆ¶ï¼Œè®©å¤§å‹çš„å‰ç«¯é¡¹ç›®åœ¨è§£å†³ä»£ç ä¾èµ–ã€å¤ç”¨å’Œæ‰©å±•çš„æ—¶å€™ï¼Œè½»æ¾è‡ªå¦‚ï¼Œæ¸¸åˆƒæœ‰ä½™ã€‚

## ä»€ä¹ˆæ˜¯æ§åˆ¶åè½¬

é¦–å…ˆï¼Œæˆ‘ä»¬æ¥èŠä¸€èŠä»€ä¹ˆæ˜¯æ§åˆ¶åè½¬ã€‚å‡è®¾æˆ‘ä»¬æ˜¯ä¸€å®¶é€ è½¦çš„ä¼ä¸šï¼Œæˆ‘ä»¬æœ‰è‡ªå·±çš„æ±½è½¦é›¶éƒ¨ä»¶ä¾›åº”å•†ï¼Œæ—©æœŸæˆ‘ä»¬å’Œæˆ‘ä»¬çš„ä¾›åº”å•†æ·±åº¦åˆä½œå…±åˆ›ï¼Œå»ºç«‹äº†æ±½è½¦å¼•æ“çš„ä¾èµ–å…³ç³»ï¼š
```typescript
import { V8Engine } from 'vendor';

class CarA {
  private engine: unknown;
  constructor() {
    this.engine = new V8Engine();
  }
  drive() {
    // ... drive ... ğŸš—
  }
}

const car = new CarA();
```
è¿™æ ·å’‹ä¸€çœ‹æ²¡å•¥é—®é¢˜ï¼Œä½†éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæˆ‘ä»¬å¸Œæœ›ç”¨æ›´æ–°çš„å¼•æ“ï¼Œæ¯”å¦‚ `V9` æ¥æ›´æ¢å­˜é‡çš„å¼•æ“ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±ä¼šå‘ç°ï¼Œå¦‚æœæˆ‘ä»¬å„ç§è½¦å‹éƒ½ç›´æ¥ä¾èµ–äº† `vendor` æä¾›çš„ `V8Engine`ï¼Œè¿™ç§ç´§è€¦åˆçš„å…³ç³»ï¼Œåœ¨é‡åˆ°å˜åŒ–çš„æ—¶å€™ï¼Œæ˜¯éå¸¸ä¸çµæ´»çš„ï¼Œ**ç‰µä¸€å‘è€ŒåŠ¨å…¨èº«**ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¾¿å¼•ç”¨äº† IoC çš„æ€æƒ³ï¼Œè®©æˆ‘ä»¬ä¸ç›´æ¥ä¾èµ– `V8Engine` çš„å…·ä½“è®¾è®¡ï¼Œè€Œæ˜¯ä¾èµ–ä¸€ä¸ª `Engine` çš„æŠ½è±¡è®¾è®¡ï¼Œå³ï¼š**å‘åŠ¨æœºå¼•æ“çš„æ ‡å‡†**ã€‚

è½åˆ°ç¨‹åºè®¾è®¡çš„è¯­å¢ƒä¸‹ï¼Œé¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡ï¼ˆOO Designï¼‰ä¸­æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„æ€æƒ³ï¼š[**é¢å‘æ¥å£ç¼–ç¨‹**](https://baike.baidu.com/item/%E9%9D%A2%E5%90%91%E6%8E%A5%E5%8F%A3%E7%BC%96%E7%A8%8B/6025286)**ï¼ˆInterface Orientedï¼‰**ï¼Œæ¥å£æè¿°äº†ç±»ç­‰æŠ½è±¡ç»“æ„åº”å½“éµå¾ªçš„æ ‡å‡†è§„èŒƒã€‚å› æ­¤æˆ‘ä»¬å¯¹ä»£ç åšä¸€æ¬¡å‡çº§ï¼Œè®©å®ç°ä¾èµ–æ¥å£è€Œéåˆ«çš„å…·ä½“å®ç°ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰å‡ºèƒ½å¤Ÿæè¿° Engine è§„æ ¼çš„æŠ½è±¡æ¥å£ï¼š
```typescript
// standard-engine-interface.ts
export interface IEngine {
  // å‘åŠ¨æœºç¼¸æ•°
  cylinders: number;
  // ... other properties
  // å¼•æ“å¯åŠ¨å‡½æ•°
  start(): void;
  // å¼•æ“åœæ­¢å‡½æ•°
  stop(): void;
  // ... other methods
}
```
æ¥ä¸‹æ¥ï¼Œä¾›åº”å•†åªéœ€è¦æŒ‰ç…§å¼•æ“æ¥å£å®ç°å‡ºå…·ä½“çš„å¼•æ“å³å¯ï¼Œæˆ‘ä»¬æŒ‰ç…§ `IEngine` å¯¹å¼•æ“ç±»çš„æŠ½è±¡ï¼Œå®ç°å¿…è¦çš„æ¥å£ï¼š
```typescript
import { IEngine } from 'standard-engine-interface';

export class V9Engine implements IEngine {
  cylinders = 4;
  start() {
  	// start engine
  }
  stop() {
    // stop engine
  }
}

export class V8Engine implements IEngine {
  cylinders = 2;
  start() {
  	// start engine
  }
  stop() {
    // stop engine
  }
}

```
æ¥ä¸‹æ¥ï¼ŒåŒä¸€ç§è½¦å‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°è¯•è£…é…ä¸åŒçš„å¼•æ“äº†ï¼š
```typescript
import { IEngine } from 'standard-engine-interface';
import { V8Engine, V9Engine } from 'vendor';

export class CarB {
  private engine: IEngine;
  constructor(engine: IEngine) {
  	this.engine = engine;
  }
}

const carV9 = new CarB(new V9Engine());
const carV8 = new CarB(new V8Engine());
```
è¿™ä¾¿æ˜¯é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡ä¸­ï¼Œç»å…¸çš„æ§åˆ¶åè½¬ï¼ˆIoCï¼‰åŸåˆ™ï¼š
> ä¸Šå±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–äºä¸‹å±‚æ¨¡å—ï¼Œä»–ä»¬å…±åŒä¾èµ–äºä¸€ä¸ªæŠ½è±¡ï¼ŒæŠ½è±¡ä¸èƒ½å¤Ÿä¾èµ–äºå…·ä½“ ï¼Œå…·ä½“å¿…é¡»ä¾èµ–äºæŠ½è±¡ã€‚

æˆ‘ä»¬çš„é€ è½¦å·¥å‚ï¼Œä¸å†å…·ä½“ä¾èµ–å¼•æ“çš„å‹å·å»è£…é…ï¼Œè€Œæ˜¯ä¾èµ–å¼•æ“çš„è®¾è®¡æ ‡å‡†ã€‚ç¨‹åºè®¾è®¡ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå®ç°ä¸å†ä¾èµ–å…·ä½“çš„å®ç°ï¼Œè€Œæ˜¯ä¾èµ–æŠ½è±¡çš„æ¥å£ï¼Œä»¥è‡³äºåœ¨å®ä¾‹å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œä¸Šå±‚æ¨¡å—å¯ä»¥æ— æ„Ÿæ›¿æ¢ä¸‹å±‚çš„æ¨¡å—ï¼Œè¿™æ ·å²‚ä¸ç¾å“‰ï¼Ÿå†è¡¥ä¸€å¼  UML ç»“æ„ç¤ºæ„å›¾ï¼Œå°±æ›´èƒ½å¤Ÿæ¸…æ™°æè¿°è¿™æ ·çš„è®¾è®¡åœ¨ OO è®¾è®¡ä¸­ç»“æ„çš„å˜åŒ–ï¼š

Beforeï¼š`CarA` ä¸ `V8Engine` ç±»æ˜¯ç´§è€¦åˆå…³ç³»ï¼ˆç›´æ¥è€¦åˆï¼‰ã€‚

![image.png](https://cdn.nlark.com/yuque/0/2021/png/84679/1640610305525-8cad0219-6098-48e4-9b42-032f288a3a7e.png#clientId=uc2a10a11-ad88-4&from=paste&height=130&id=Ap2dS&originHeight=260&originWidth=940&originalType=binary&ratio=1&rotation=0&showTitle=false&size=23466&status=done&style=none&taskId=uaf97ab2f-dacb-4cfe-98aa-8cd598c8a72&title=&width=470)

Afterï¼š`CarA` å’Œ `V8Engine` ä»¥åŠ `V9Engine`ï¼Œå…±åŒä¾èµ–ä¸€ä¸ªæŠ½è±¡æ¥å£ï¼Œå³ `IEngine`ã€‚<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/84679/1640610245291-3d9f12fc-9ef7-4415-8cb8-ff3c33d88249.png#clientId=uc2a10a11-ad88-4&from=paste&height=261&id=Yt1R3&originHeight=522&originWidth=1060&originalType=binary&ratio=1&rotation=0&showTitle=false&size=61712&status=done&style=none&taskId=uc8c5b732-8ca3-4e9a-b74a-21829f5b3e8&title=&width=530)

è¿™æ ·åšçš„å¥½å¤„åœ¨äºæœªæ¥çš„ Engine ç±»å‹ï¼Œåªè¦å®ç° IEngine è¦æ±‚çš„æ¥å£ï¼Œä¾¿å¯ä»¥å…¼å®¹ CarAï¼ŒCarA ä¹Ÿå¯ä»¥åšåˆ°æ— æ„ŸçŸ¥æ›¿æ¢å…·ä½“çš„ Engine ç±»å‹ã€‚

## ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥

ç†è§£äº† IoCï¼ŒDI ä¹Ÿå°±æ›´å®¹æ˜“ç†è§£äº†ã€‚

æˆ‘ä»¬ç»§ç»­ä»¥é€ è½¦ä¸ºä¾‹ï¼Œæ¥è®²è¿° IoC å’Œ DI è¿™å¯¹ã€Œ**æµ·å°”å…„å¼Ÿ**ã€æ˜¯å¦‚ä½•é…åˆå¥½ï¼Œè§£å†³å®é™…ç”Ÿäº§ä¸­çš„é—®é¢˜çš„ã€‚

è®¾æƒ³åœ¨è¿™ä¸ªé€ è½¦è¿‡ç¨‹ä¸­ï¼Œå¼•æ“ï¼ˆEngineï¼‰è¿˜ä¼šä¾èµ–å‘åŠ¨æœºçš„è½´æ‰¿ï¼ˆBearingï¼‰ï¼Œè€Œè½´æ‰¿çš„è§„æ ¼ä¹Ÿæœ‰è®¸å¤šç§ï¼Œå› æ­¤å½“æˆ‘ä»¬åœ¨ç”Ÿäº§ä¸€è¾†æ±½è½¦ï¼ˆCarï¼‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸ä»…ä»…è¦ä¸Šæ¸¸åˆ¶é€ å‡ºåˆç†çš„å¼•æ“ï¼Œä¸Šæ¸¸çš„ä¾›åº”å•†è¿˜éœ€è¦å‘å®ƒçš„ä¸Šæ¸¸ç´¢è¦ä¾èµ–çš„è½´æ‰¿ï¼Œè½´æ‰¿è¿˜éœ€è¦å‘å®ƒçš„ä¸Šæ¸¸ç´¢è¦è½´æ‰¿çš„ææ–™ ... ä¸ºæ­¤ä¼šå½¢æˆä¸€ä¸ªå¤æ‚çš„ç”Ÿäº§å…³ç³»ï¼Œåœ¨ç¨‹åºè®¾è®¡ä¸­ï¼Œæˆ‘ä»¬å«å®ƒä¾èµ–ç½‘ç»œï¼ˆDependency Networkï¼‰ã€‚

å¦‚æœç”¨ä»£ç åšç¤ºæ„é‚£ä¾¿æ˜¯ï¼š

```typescript
const car = new CarA(new V8Engine(new Bearing(new BearingMaterial(), ... )));
```

ä¾èµ–æ³¨å…¥ä¸»è¦æ„åœ¨å¸®æˆ‘ä»¬ç³»ç»Ÿæ€§åœ°åˆ†æä¾èµ–ç½‘ç»œï¼Œå°†ä¸€ä¸ªå¯¹è±¡æˆ–è€…ä¸€ä¸ªç±»çš„ç”Ÿäº§è¿‡ç¨‹åšäº†å°è£…ç®€åŒ–ã€‚ä¾èµ–æ³¨å…¥çš„æ¡†æ¶ä¹Ÿä¾¿æ˜¯åå‰¯å…¶å®çš„æ˜¯ç±»æˆ–è€…å¯¹è±¡çš„ **ç”Ÿäº§å·¥å‚**ã€‚

> ä¸€ä¸ªç®€å•çš„ DI ç³»ç»Ÿï¼Œèƒ½å¤Ÿåœ¨ç¨‹åºçš„è¿è¡Œæ—¶ä¸­åŠ¨æ€çš„è§£æå‡ºè°ƒç”¨æ–¹éœ€è¦çš„å¯¹è±¡æˆ–è€…å…¶å®ƒæ•°æ®ç±»å‹ï¼Œåœ¨å¼ºç±»å‹çš„è¯­è¨€è®¾è®¡ä¸­ï¼Œè¿™æ˜¯ä¸€ç§è§£è€¦åˆçš„é‡è¦å®ç°æ–¹å¼ã€‚


å¦‚æœæˆ‘ä»¬ä½¿ç”¨ TS æ¥è¡¨ç¤ºçš„è¯ï¼Œå°±å¥½æ¯”ï¼š
```typescript
// ä¾èµ–çš„æä¾›æ–¹å¯ä»¥é€šè¿‡ bindDependency æ–¹æ³•æä¾›å¼•æ“å’Œè½´æ‰¿ç­‰ç­‰çš„æ„é€ å‡½æ•°ï¼ˆç±»ï¼‰
// å°†å…·ä½“çš„å¼•æ“ã€è½´æ‰¿çš„ç±»ï¼Œç»‘å®šåˆ°å·¥å‚çš„ç”Ÿäº§çº¿ä¸Š
DIFactory.bindDependency('engine', V8Engine);
DIFactory.bindDependency('bearing', Bearing);
// ...

// å½“éœ€è¦æè½¦çš„æ—¶å€™(get)ï¼Œå·¥å‚ä¼šæŒ‰ç…§å®ç°ç»‘å®šå¥½çš„ç”Ÿäº§çº¿å¼€å§‹é€ è½¦æµç¨‹
// å¤æ‚çš„ã€Œç»„è£…è¿‡ç¨‹ã€ï¼šä¾èµ–åˆ†æã€å¯¹è±¡å®ä¾‹åŒ– ... ç­‰ç­‰éƒ½ä¼šäº¤ç»™è¿™ä¸ªä¾èµ–å·¥å‚å‡½æ•°å»è´Ÿè´£ç”Ÿæˆ
const car = DIFactory.get<ICar>('car');
car.drive();
```
æˆ‘ä»¬å°†ç»„è£…çš„è¿‡ç¨‹åšäº†å°è£…ï¼Œåªéœ€è¦ä¸€ä¸ªè½»æ¾çš„ `get` å‡½æ•°ï¼Œå°±å®ç°äº†å°†æ±½è½¦é›¶éƒ¨ä»¶è¿›è¡Œè£…é…å’Œç»„è£…ï¼Œè¿™ä¸ªåŠ¨æ€ç»„åˆç»„è£…çš„è¿‡ç¨‹ï¼ˆå¯¹è±¡ä¾èµ–ç½‘ç»œå®ä¾‹åŒ–çš„è¿‡ç¨‹ï¼‰ï¼Œä¾¿æ˜¯ä¾èµ–æ³¨å…¥çš„è¿‡ç¨‹ã€‚

æˆ‘ä»¬å†å±•å¼€ç»†ä¸€ç‚¹ï¼š

- `'engine'` å’Œ `'car'` ä»¥åŠ `'bearing'` è¿™ç§æ ‡è¯†ç¬¦ï¼Œæˆ‘ä»¬ä¸€èˆ¬å«åš **ä¾èµ–æ³¨å…¥ Token**ï¼Œå®ƒä»¬ä¸€èˆ¬ä¼šè¢«è®¾è®¡æˆå…¨å±€å”¯ä¸€ï¼Œç”¨äºæ ‡æ³¨å”¯ä¸€çš„ç±»å‹ã€‚
- `bindDependency` å‡½æ•°ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º** ä¾èµ–ç»‘å®š**ï¼Œå³å°†ç±»å‹å®ç°ï¼ˆç±»ã€å¯¹è±¡ç­‰ï¼‰å’Œæ§åˆ¶åè½¬å®¹å™¨ï¼ˆ`IoCContainer`ï¼Œéƒ¨åˆ†æ¡†æ¶ä¸­ä¹Ÿå«åš `Injector` ä¾èµ–æ³¨å…¥å™¨ï¼‰åšå…³è”ã€‚
- `get` å‡½æ•°ï¼Œåˆ™æ˜¯ä¸€ä¸ªå¯¹è±¡æå‡ºï¼ˆåˆ†æä¾èµ–å…³ç³»ï¼Œç»„è£…ç”Ÿæˆå¯¹è±¡ï¼‰çš„è¿‡ç¨‹ï¼Œä¾èµ–æ³¨å…¥æ¡†æ¶ä¼šåˆ†æå½“å‰ç´¢è¦çš„ä¾èµ–æ³¨å…¥ Token å¯¹åº”çš„ç±»å‹ï¼Œç„¶åé€’å½’åœ°åˆ†æå®ƒçš„ä¾èµ–ï¼Œæœ€ç»ˆå®ä¾‹åŒ–è¿™äº›å¯¹è±¡ï¼Œå®Œæˆæœ€ç»ˆå¯¹è±¡çš„æ‹¼è£…ã€‚

ä¸šç•Œæ¯”è¾ƒè‘—åçš„æ§åˆ¶åè½¬æ¡†æ¶ï¼Œä»¥ [Inversify](https://github.com/inversify/InversifyJS/) ä¸ºå…¸å‹ã€‚

:::info
æ—©æœŸç¬”è€…åˆ†æäº† Inversify 5.0 çš„å®ç°åŸç†ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œå¦‚æœå¯¹ä¾èµ–æ³¨å…¥æ¡†æ¶æ¯”è¾ƒæ„Ÿå…´è¶£å¯ä»¥é˜…è¯» [è¿™ç¯‡æ–‡ç« ](https://www.yuque.com/surfacew/daily-learn/gcl771) æ·±å…¥ï¼Œæ¡†æ¶çš„å®ç°ä¸­å…³é”®çš„ç±»ä½¿ç”¨ UML è¡¨ç¤ºå‚è€ƒå¦‚ä¸‹ï¼Œå¯å½¢æˆä¸€ç§åˆæ­¥çš„å°è±¡ã€‚
:::

![image.png](https://cdn.nlark.com/yuque/0/2021/png/84679/1640613165049-f03e09b6-a977-4be6-8877-b531d88b97d2.png#clientId=uc2a10a11-ad88-4&from=paste&height=533&id=U9IyJ&originHeight=1066&originWidth=1500&originalType=binary&ratio=1&rotation=0&showTitle=false&size=248533&status=done&style=none&taskId=u3aa58547-5ef8-4b67-a308-cbdebf9b9b1&title=&width=750)<br />å›¾ï¼šInversify æ¡†æ¶ä¸­ä¸»è¦çš„ç±»å’Œå¯¹è±¡å…³ç³»

## æœ€ä½³å®è·µã®æ¢ç´¢

ç†è§£äº† DI å’Œ IoCï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·æ¥ç»“åˆå®é™…çš„æ¡ˆä¾‹ï¼Œå°è¯•åœ¨å‰ç«¯é¡¹ç›®ä¸­æ‰¾åˆ° DI å’Œ IoC ç›®å‰çš„æœ€ä½³å®è·µï¼Œå°¤å…¶åœ¨ç¨‹åºç»“æ„è®¾è®¡å’Œå·¥ç¨‹ä¸Šæ‰¾åˆ°ä¸€ç§è®¾è®¡å¹³è¡¡ã€‚

### Angular çš„å®ç°æœºåˆ¶

> è¯¥å°èŠ‚ï¼Œå¯¹ Angular ä¸å¤ªç†Ÿæ‚‰çš„åŒå­¦æ¥è¯´ï¼Œå¯èƒ½ä¼šæ¯”è¾ƒæ™¦æ¶©ï¼Œå¯ä»¥è·³åˆ°ä¸‹ä¸€èŠ‚é˜…è¯»ã€‚


ç¬”è€…ä¸€ç›´è§‰å¾— Angular æ˜¯ä¸€ä¸ª**æœ€é€‚åˆæ„ç­‘å¤æ‚ Web UI ç³»ç»Ÿçš„æ¡†æ¶**ã€‚å®ƒé‡Œé¢å®šä¹‰äº†ä¸€ä¸ªéå¸¸å®Œå¤‡çš„æ¨¡å—åŒ–ï¼ˆModularï¼‰ä»¥åŠ DI ç³»ç»Ÿï¼Œå°¤å…¶é€‚åˆ OO ç»éªŒæ¯”è¾ƒä¸°å¯Œçš„å‰ç«¯å›¢é˜Ÿã€‚ä»¥ Angular 12 å®šä¹‰çš„å‡ ä¸ªå…³é”®ç±»å‹ä¸ºä¾‹ï¼š

![](https://cdn.nlark.com/yuque/0/2021/jpeg/84679/1630331015420-797fb517-befd-4ec6-8f63-2fba57679ca7.jpeg)

Angular å®ƒçš„ä¸»è¦ç±»å‹åˆ†ä¸ºäº†ä¸Šé¢çš„ç»“æ„ã€‚å¯ä»¥çœ‹åˆ°æœåŠ¡ï¼ˆServiceï¼‰ä½œä¸º Angular ä¾èµ–æ³¨å…¥ç³»ç»Ÿçš„æä¾›è€…ï¼ˆProviderï¼‰ï¼Œé€šè¿‡ `@injectable()` è£…é¥°å™¨æ³¨å…¥åˆ° Angular çš„ `Injector`ï¼ˆä¾èµ–æ³¨å…¥å™¨ï¼‰ ä¸­ã€‚è€Œåœ¨ NgModule / Directive / Component ä¸­å¯ä»¥é€šè¿‡å£°æ˜å¼çš„æ–¹å¼å°†æœåŠ¡åœ¨ç±»çš„è£…é¥°å™¨ï¼ˆDecorator)ä¸Šæä¾›ã€‚Angular çš„è¿è¡Œæ—¶å®ä¾‹åŒ–è¿™äº›å¯¹è±¡çš„æ—¶å€™ï¼Œä¼šä½¿ç”¨å†…éƒ¨çš„ `Injector` æå‡ºç¬¦åˆé…ç½®è¦æ±‚çš„å¯¹è±¡ï¼Œåœ¨æ„é€ å™¨å‡½æ•°ä¸­æ³¨å…¥ã€‚
```typescript
import { Injectable } from '@angular/core';
import { HEROES } from './mock-heroes';
import { Engine } from '../engine.service';

@Injectable({
  providedIn: 'root',
})
export class CarService {
  constructor(private engineService: Engine) {  }
  getEngine() {
    this.engineService.start('start ...');
    return this.engineService;
  }
}
```
> å…¶ DI å½¢å¼é¢‡ä¸ºä¼˜é›… ğŸ˜ ~


:::info
ç¬”è€…æ›¾ç»å°± Angular 12 çš„ DI ç³»ç»Ÿæºä»£ç åšäº†ç®€å•åˆ†æï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç§»æ­¥ [è¿™ç¯‡æ–‡ç« ](https://www.yuque.com/surfacew/daily-learn/osexp4#ZOmt5) æ·±å…¥äº†è§£å…¶è®¾è®¡å’Œå®ç°æ€è·¯ã€‚
:::

### åŸºäº Inversify æ‰“é€  DI ä¸šåŠ¡æ¡†æ¶

çœ‹å®Œäº† Angular ç³»ç»Ÿçš„è®¾è®¡ï¼Œåƒé˜¿é‡Œä½œä¸º React å¤§å‚ï¼Œå¦‚æœæœŸæœ›åœ¨ä¸šåŠ¡ä¸­å®ç°ä¸€å¥—ç±»ä¼¼çš„ DI ç³»ç»Ÿåšå¥½ IoCï¼Œåˆåº”è¯¥æ€ä¹ˆå»å®Œæˆå‘¢ï¼Ÿç¬”è€…åœ¨è¿™é‡Œï¼Œç»™å‡ºä¸€äº›å®æˆ˜æ€§çš„æ€è€ƒï¼Œä¹ŸæŠ›ç –å¼•ç‰ï¼Œå’Œå¤§å®¶ä¸€èµ·æ¢è®¨æœ€ä½³çš„å®è·µèŒƒå¼ã€‚

> å‡å®šè¯»è€…ï¼š
> - ç†Ÿæ‚‰ [Typescript](https://www.typescriptlang.org/)ï¼Œå¹¶ç†Ÿæ‚‰ [Typescript Decorator](https://www.typescriptlang.org/docs/handbook/decorators.html) ï¼Œå¹¶å¼€å¯ç›¸å…³çš„é…ç½®
> - äº†è§£äº†åŸºæœ¬çš„ [Inversify](https://inversify.io/) æ¡†æ¶çš„ APIã€‚


#### 1. ä½¿ç”¨è£…é¥°å™¨å®ç°ä¾èµ–æ³¨å…¥ç³»ç»Ÿ

> ğŸ’ Decorators to rule them all !


å¾—ç›Šäº Java çš„ [æ³¨è§£ç³»ç»Ÿ](https://www.runoob.com/w3cnote/java-annotation.html)ï¼ˆAnnotationï¼‰çš„è®¾è®¡ï¼ŒTypescript ç»™å‡ºäº†ç±»ä¼¼çš„ Decorator æ–¹æ³•ï¼Œç”¨äºå¯¹ç±»ã€ç±»çš„æ„é€ å™¨å‚æ•°ã€å±æ€§ç­‰ç­‰ï¼Œé€šè¿‡è£…é¥°å™¨çš„æ–¹å¼ï¼Œä»¥æ¸…æ™°æ˜“æ‡‚ï¼Œä¸”ä¾µå…¥ç¨‹åº¦è¾ƒä½çš„æ–¹å¼å®ç°äº† DI ç³»ç»Ÿçš„è¦æ±‚ï¼Œæˆ‘ä»¬ç»§ç»­ä½¿ç”¨é€ è½¦ä¸ºä¾‹çœ‹ä¸€ä¸‹ Inversify çš„åŸºç¡€ API ä½¿ç”¨ï¼š
```typescript
import { Container, injectable, inject } from "inversify";

// å£°æ˜ V8Engine æ˜¯å¯ä»¥è¢«ä¾èµ–æ³¨å…¥æ¡†æ¶è¯†åˆ«çš„
@injectable()
class V8Engine {
    public start() {
      	// ... ğŸ ...
        return "v8";
    }
}

@injectable()
class V9Engine {
    public start() {
        // ... ğŸ ...
        return "v9";
    }
}

// å£°æ˜ Car ç±»æ˜¯å¯ä»¥è¢«ä¾èµ–æ³¨å…¥æ¡†æ¶è¯†åˆ«çš„
@injectable()
class Car implements ICar {
    private engine: V8Engine;
    public constructor(engine: V8Engine) {
        this.engine = engine;
    }
    public start() { return this.engine.start(); };
    public stop() { return this.engine.stop(); };
}

// åˆ›å»ºä¸€ä¸ªä¾èµ–æ³¨å…¥å®¹å™¨
const container = new Container();
// è¿›è¡Œä¾èµ–ç»‘å®š
container.bind<IEngine>(V8Engine).to(V8Engine);
container.bind<IEngine>(V9Engine).to(V9Engine);
container.bind<ICar>(Car).to(Car);

// è§£æ Car å®ä¾‹ï¼Œå¹¶å°† V8Engine å®ä¾‹åŒ–åä¼ å…¥ Car çš„æ„é€ å™¨å‡½æ•°ä¸­ï¼Œä½œä¸ºå‚æ•°åˆå§‹åŒ– Car å®ä¾‹
container.get(Car);
```
æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•´ä¸ª DI è¿‡ç¨‹é€šè¿‡ `@injectable()` å®Œæˆäº† DI æ¡†æ¶çš„è½»é‡ä¾µå…¥ï¼Œä½¿å¾—ç¼–å†™åŠå…¶å°‘é‡çš„ä»£ç ï¼Œå°±èƒ½å¤Ÿå’Œæ¡†æ¶äº§ç”Ÿå…³è”ã€‚

### 2. å¯¹ IoC å®¹å™¨çš„æ›´è¿›ä¸€æ­¥å°è£…

> ğŸš€ Inversify æœ¬èº«æ˜¯ä¸€ä¸ªå¥½æ¡†æ¶ï¼Œä½†æ˜¯å„ç§èŠ±é‡Œèƒ¡å“¨çš„ API ä½¿ç”¨ï¼Œä¹Ÿç»™ä¸šåŠ¡å±‚å¸¦æ¥æ›´é«˜çš„è®¤çŸ¥æˆæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘å·§å¦™åœ°å°è£…éƒ¨åˆ†æ–¹æ³•ï¼Œ**æä¾›ç»™ä¸Šå±‚ä½¿ç”¨ï¼Œä»¥é™ä½ã€Œè®¤çŸ¥æˆæœ¬ã€**ã€‚Inversify è¿˜æ˜¯æœ‰ä¸€å®šçš„å­¦ä¹ æˆæœ¬çš„ï¼Œå…‰ API å°±è¶…è¿‡äº† 40+ï¼Œç›´æ¥ä½¿ç”¨å¯¹äºæ–°æ‰‹å’Œå°ç™½ç”¨æˆ·éå¸¸ä¸å‹å¥½ï¼Œä»¥ ğŸ‘‡ çš„æ–‡æ¡£ä¸ºä¾‹ï¼Œç†è§£ Inversify çš„ä½¿ç”¨ï¼Œè‡³å°‘è¦é€šè¯»ä¸‹é¢çš„æ–‡ç« ï¼Œå½¢æˆç†è§£ã€‚
> ![image.png](https://cdn.nlark.com/yuque/0/2021/png/84679/1640618377740-53a093d4-9e58-4958-8de5-87f316fe77ad.png#clientId=u92fce47d-36d5-4&from=paste&height=589&id=kNRM8&originHeight=1178&originWidth=2146&originalType=binary&ratio=1&rotation=0&showTitle=false&size=632586&status=done&style=none&taskId=uc40e61a4-9b52-44d7-aae8-60d9881945c&title=&width=1073)


Inversify å¯¹æä¾›äº†æ¯”è¾ƒåŸå§‹ç‰ˆæœ¬çš„ IoC å®¹å™¨ï¼Œå®ƒæä¾›äº†æœ€åŸå­åŒ–çš„åŠŸèƒ½ã€‚**æˆ‘ä»¬å…¶å®å¯ä»¥å¯¹å®ƒåšè¿›ä¸€æ­¥å°è£…ï¼Œæ¥è®©ä½¿ç”¨è€…æ›´å¥½åœ°ä½¿ç”¨ï¼Œè€Œä¸ç”¨å…³å¿ƒå…¶å®ç°ç»†èŠ‚**ã€‚

è¿™é‡Œä¸¾å‡ ä¸ªå¯è¡Œçš„è®¾è®¡è§„åˆ™ï¼š

- ä¸šåŠ¡ä¾èµ–æ³¨å…¥æ¡†æ¶ä¸­ï¼Œ**åªèƒ½å¤Ÿæå‡ºå¯¹è±¡ç±»å‹**ï¼ˆå•ä¸€ç±»å‹æå‡ºï¼Œå¯ä»¥é™ä½å¤§é‡çš„ç†è§£æˆæœ¬ï¼Œå…¶å®å¯¹è±¡å°±å·²ç»å¯ä»¥ Cover ä½ 99% çš„è®¾è®¡äº†ï¼Œå¯ä»¥æœç»å¤æ‚çš„ API ä½¿ç”¨å¸¦æ¥çš„è®¤çŸ¥æˆæœ¬ï¼‰
- å°† `bind` çš„è¿‡ç¨‹ï¼Œåœ¨ä¸šåŠ¡æ¡†æ¶ä¸­è‡ªåŠ¨åŒ–æ‰ï¼Œå¼€å‘è€…ä¸ç”¨å…³å¿ƒ `bind` è¿‡ç¨‹
- åœ¨ IoC å®¹å™¨å±‚æä¾› `get` è¿‡ç¨‹ä¸­çš„ç¨³å®šæ€§ä¿è¯ï¼Œä»¥è‡³äºè§£æå‡ºé”™çš„æ—¶å€™æœ‰ fallback ï¼ˆé™çº§ï¼‰çš„æ–¹æ¡ˆ
- åœ¨ IoC å®¹å™¨å±‚å†…ç½®ç»Ÿè®¡ `IoC` æå‡ºçš„æ€§èƒ½åˆ†ææ’ä»¶ï¼Œå¯ä»¥å¯¹é«˜æ€§èƒ½æ“ä½œè¿›è¡Œé«˜é™
- åœ¨ IoC å®¹å™¨å±‚æé…ç½®å¼çš„æ–¹å¼ï¼Œæ¥å°è£…å¯¹ Inversify çš„ APIï¼Œè®©ä¸šåŠ¡å±‚æ¡†æ¶ä½¿ç”¨è€…æ ¹æœ¬ä¸ç”¨å…³å¿ƒ Inversify åº•å±‚å®¹å™¨çš„å®ç°
- ...

IoC å®¹å™¨åœ¨ä¸šåŠ¡å±‚å¯ä»¥åšå¾ˆå¤šäº‹æƒ…ï¼Œæ¥å±è”½åº•å±‚çš„å¤æ‚åº¦ï¼Œå¯¹ä¸šåŠ¡å¼€å‘æä¾›ç®€å•çš„è§£å†³æ–¹æ¡ˆã€‚**å¯¹äºä½¿ç”¨è€…è€Œè¨€ï¼Œä»–ä»¬åªéœ€è¦çŸ¥é“æœ‰ **`**get**`** æ–¹æ³•å³å¯**ã€‚

```typescript
// di-framework.ts
export class DIContainer {
  get<T>(serviceIdentifier: Token): T;
}
export const container = new DIContainer();
```

#### 3. ä¾èµ–æ³¨å…¥ Token ä¼˜åŒ–

é€šè¿‡ä¸šåŠ¡æ¡†æ¶æŒ‡å®š token çš„è®¾è®¡è§„åˆ™ï¼Œæˆ‘ä»¬å¯ä»¥ç®€åŒ–ä¾èµ–æ³¨å…¥ token å¸¦æ¥çš„è®¤çŸ¥å¤æ‚åº¦ï¼Œä¸ºæ­¤æˆ‘ä»¬å¯ä»¥åšå¦‚ä¸‹çš„è§„åˆ™é™åˆ¶ï¼š

- Token ä½¿ç”¨å­—ç¬¦ä¸²ä¿è¯å”¯ä¸€æ€§ï¼Œæ¯”å¦‚ï¼š`engine` ä¿è¯æ˜¯å¿è€…ç±»å‹çš„å…¨å±€å”¯ä¸€æ€§
- Token å¯ä»¥æ˜¯å®ç°äº† `toString` æ–¹æ³•çš„ä»»ä½•å¯¹è±¡ï¼Œè¯¥è§„åˆ™å¯ä»¥è®©åç»­ä¾èµ–æ³¨å…¥çš„è§£æ Token å’Œåç»­é¢å‘æ¥å£çš„è®¾è®¡æ•´åˆåœ¨ä¸€èµ·

```typescript
// tokens.ts
import { createServiceIdentifier } from 'di-framework';
export const Engine = createServiceIdentifier('engine');
export const Tire = createServiceIdentifier('tire'); // è½®èƒ
export const Car = createServiceIdentifier('car');
```

åç»­æˆ‘ä»¬å¯ä»¥è®© Engine å’Œ Car ç­‰é€šè¿‡ `createServiceIdentifier`  è¿™ä¸ª Token çš„å·¥å‚å‡½æ•°ï¼ŒåŠ å·¥ï¼Œå®ç° `toString()` çš„æ–¹æ³•ï¼ŒåŒæ—¶æœ‰å¯ä»¥æ‰¿å½“å…·å¤‡ã€Œè¯­ä¹‰ã€çš„åŠŸèƒ½å‹ Decoratorï¼Œç¨ååœ¨æœ€ç»ˆæ•ˆæœä¸­ï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¼˜é›…åœ°å®ç°æ–¹å¼ã€‚

#### 4. å°è£… Provide è£…é¥°å™¨

ä¸ºäº†è¿›ä¸€æ­¥æ”¶æ•›è£…é¥°å™¨ï¼Œæˆ‘ä»¬å¯¹ç”¨æˆ·æä¾› `@provide` è£…é¥°å™¨ï¼Œç”¨äºæä¾›ç±»æˆ–è€…å¯¹è±¡ã€‚
```typescript
// impl.ts
import { Engine, Car, Tire } from 'tokens';
import { IEngine } from 'standard-engine-interface';

// engine.v8.impl.ts
@provide(Engine)
class V8Engine implements IEngine {
  start() {
    // ... ğŸ V8 ...
  }
}

// engine.v9.impl.ts
@provide(Engine)
class V9Engine implements IEngine {
  start() {
    // ... ğŸ V9 ...
  }
}
```
åœ¨ä¸åŒçš„æ–‡ä»¶ä¸­ä½¿ç”¨ `@provide` è£…é¥°å™¨ï¼Œæä¾›ä¸åŒçš„ç±»æ¥ç»‘å®š `Engine` Tokenï¼Œå³å¯ä»¥å®ç°å¯¹æ±½è½¦å¼•æ“çš„æ— æ„ŸçŸ¥æ›¿æ¢ï¼Œåªè¦å®ç°äº† `IEngine` çš„å¼•æ“å‡å¯ä»¥ã€‚

#### 5. å®ç°æ¶ˆè´¹ä¾èµ–å…³ç³»

åœ¨ `MyCar` ç±» Constructor ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ç±»æ„é€ å‡½æ•°ä¸­æ³¨å…¥å¼•æ“å’Œè½®èƒï¼š
```typescript
// car.impl.ts
import { container } from 'di-framework';
import { Engine, Tire, Car } from 'tokens';

// ç›´æ¥å®ç°
import 'engine.v9.impl';

@provide(Car)
class MyCar {
  constructor(
    @Engine private engine: IEngine,
    @Tire   private tire: ITire,
  ) {
    // init other parts ...
  }
  drive() {
    this.engine.start();
  }
}

// æœ€ç»ˆæˆ‘ä»¬åªéœ€è¦é€šè¿‡ Car Identifier æå‡º Car å®ä¾‹å³å¯
const car = container.get<MyCar>(Car);
```
å¯ä»¥çœ‹åˆ°ï¼Œä¸Šè¿°è¿‡ç¨‹ï¼Œå°†å¤æ‚çš„ Inversify æ¡†æ¶çš„ç”¨æ³•ï¼Œå‡ç»ƒä¸ºï¼š

- `createServiceIdentifier` åˆ›å»ºä¾èµ–æ³¨å…¥çš„å”¯ä¸€ Tokenï¼ŒåŒæ—¶ä¹Ÿæ˜¯æ„é€ å™¨å‚æ•°çš„è£…é¥°å™¨ï¼ˆä¸¤ç”¨å¯¹è±¡ï¼Œå…·å¤‡è¯­ä¹‰ï¼‰
- `@provide(ServiceIdentifier)` æä¾›ä¾èµ–æ³¨å…¥çš„æœåŠ¡ï¼Œå¹¶è‡ªåŠ¨å°† Token å’Œè£…é¥°çš„ç±»åšç»‘å®š
- `@ServiceIdentifier` å…·å¤‡è£…é¥°è¯­ä¹‰çš„æ„é€ å™¨å‚æ•°çš„è£…é¥°å™¨ï¼Œåœ¨ç±»çš„æ„é€ å‡½æ•°ä¸­è¡¨ç¤ºä¾èµ–æ³¨å…¥å…³ç³»
- `container.get` è·å–ä¾èµ–åˆ†æï¼Œæå‡ºéœ€è¦çš„å¯¹è±¡ï¼Œå®Œæˆæ•´ä¸ª DI è¿‡ç¨‹

ä¿ƒä½¿ä½¿ç”¨è€…ï¼ˆä¸šåŠ¡å¼€å‘è€…ï¼‰åªéœ€è¦æŒæ¡ 4 ä¸ª API å°±å¯ä»¥å®Œæˆä¸»è¦çš„ DI ç³»ç»Ÿè®¾è®¡ï¼Œæ•´ä½“ç®€åŒ–äº†ä¾èµ–æ³¨å…¥çš„ç†è§£æˆæœ¬ï¼ŒåŒæ—¶å…¼é¡¾ DI é£æ ¼çš„ä¼˜é›…æ€§ã€‚å¯ä»¥åœ¨å®æˆ˜è¿‡ç¨‹ä¸­é€šè¿‡è¾ƒä½çš„æˆæœ¬å°è£… Inversify å®ç°ã€‚å½“ç„¶å¯¹äºæœ¬èº«éœ€æ±‚å°±æ¯”è¾ƒç®€å•çš„ï¼Œä¹Ÿå¯ä»¥æ‰‹æ’¸ä¸€ä¸ªç®€å•ç‰ˆæœ¬çš„ Inversify æˆ–è€…ä½¿ç”¨å…¶å®ƒä¸šç•Œå¼€æºçš„ DI æ¡†æ¶è¾…åŠ©å®ç°ã€‚
## å°ç»“

èŠäº†è¿™ä¹ˆå¤šï¼Œç›¸ä¿¡å¤§å®¶å¯¹ DI & IoC åº”è¯¥ä¼šæœ‰æ›´æ·±å±‚æ¬¡çš„ç†è§£å§ï¼Œæˆ‘ç›¸ä¿¡éšç€æœªæ¥å‰ç«¯æŠ€æœ¯çš„è§„æ¨¡åŒ–å‘å±•ï¼Œ**Web åº”ç”¨å¿…ç„¶ä¼šå¼•å…¥æ›´å¤šçš„å¤æ‚æ€§ï¼Œå½“å¤§å®¶é¢å¯¹è‡ªå·±çš„æ¨¡å—ï¼Œåœ¨è®¾è®¡å…¶æ¨¡å—åŒ–ç³»ç»Ÿã€ä¾èµ–ç³»ç»Ÿã€æ‰©å±•ç³»ç»Ÿçš„æ—¶å€™ï¼Œä¸€å®šä¼šå‘ç° DI å’Œ IoC çš„è®¾è®¡æœºåˆ¶ä¼šåœ¨è¿™é‡Œå¤§æ”¾å…‰å½©**ï¼

## å‚è€ƒ

- [IoC](https://en.wikipedia.org/wiki/Inversion_of_control) wiki & [DI](https://en.wikipedia.org/wiki/Dependency_injection) wikiï¼Œç»´åŸºç™¾ç§‘å®˜æ–¹å®šä¹‰
- [Angular DI ç³»ç»Ÿçš„è®¾è®¡å’Œå®ç°åˆ†æ](https://angular.io/guide/dependency-injection)ï¼šAngular å®˜æ–¹æ–‡æ¡£
- [Inversify æ¡†æ¶ä»‹ç»å’Œä½¿ç”¨æŒ‡å—](https://zhuanlan.zhihu.com/p/341567302)ï¼ˆä¸­æ–‡ï¼‰
- [Inversify æ¡†æ¶è®¾è®¡æ€è€ƒ](https://github.com/inversify/InversifyJS/) by [@Arno(surfacew)](/surfacew) ä¸ªäººæ€è€ƒ
